#!/usr/bin/env bash

######################################
#
# pushes configuration to a set of 
# nodes defined by a security group
#
######################################

die() {
    echo $1
    exit 1
}

if [[ -z $1 || -z $2 ]]; then
    die "usage $0 <instance address> <branch>"
fi

INSTANCE_ADDRESS=${1}
BRANCH=${2}
GIT_PUPPET_USER=gitpuppet
GIT_PUPPET_REPO=configure
REPO_ROOT=$(dirname $0)/..

# check out a bare copy of the repo referenced so that 
# all pushes will be the same if something happens
# to the referenced repository during the cycle of 
# updates.
REPO_COPY=$(mktemp -d /tmp/update-nodes.XXXXXX)
echo "cloning repository into \"${REPO_COPY}\""
git clone --bare ${REPO_ROOT} ${REPO_COPY} || die "failed to clone repository."
cd ${REPO_COPY}

# perform push
echo "Pushing to ${INSTANCE_ADDRESS}"
git push -f ${GIT_PUPPET_USER}@${INSTANCE_ADDRESS}:${GIT_PUPPET_REPO} ${BRANCH}:master
echo "done."

rm -rf ${REPO_COPY}
