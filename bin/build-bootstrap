#!/usr/bin/env bash

#######################################################
#
# usage: create-bootstrap-script <directory> <boostrap-file>
#
# creates a bootstrap package intented for ec2 + 
# ubuntu "cloud init" from a directory.
#
# the directory is expected to contain whatever files
# are needed and an executable script named 'run'
#
# ubuntu cloud init will ungzip and execute
# the bootstrap file if provided as the ec2 
# 'user data' for an instance running an ubuntu 
# cloud guest image. 
#
######################################################

PAYLOAD_DIR=${1}
OUTPUT_FILE=${2}
BUILD_FILE=$(mktemp /tmp/bbs-XXXXXX)

if [[ -z "${PAYLOAD_DIR}" || -z "${OUTPUT_FILE}" ]]; then
    echo "creates bootstrap scripts for ec2 nodes from a directory."
    echo "usage ${0} <payload dir> <output file>"
    exit 1
fi

# untar/execute header
cat > ${BUILD_FILE} <<EOF
#!/usr/bin/env bash
TMPDIR=\$(mktemp -d /tmp/bootstrap.XXXXXX)
echo "extracting bootstrap into \$TMPDIR"
ARCHIVE=\$(awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' \$0)
tail -n+\$ARCHIVE \$0 | tar xv -C \$TMPDIR
CDIR=\$(pwd)
cd \$TMPDIR
./run
cd \$CDIR
#rm -rf \$TMPDIR
exit 0
__ARCHIVE_BELOW__
EOF
# archived contents
tar -cLf - -C ${PAYLOAD_DIR} . >> ${BUILD_FILE}

# gzip entire script
gzip -c ${BUILD_FILE} > ${OUTPUT_FILE}
rm ${BUILD_FILE}

echo "created bootstrap ${OUTPUT_FILE}"
exit
